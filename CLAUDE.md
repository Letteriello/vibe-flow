## Documentacao de Arquitetura

O projeto vibe-flow possui documentacao completa em `docs/architecture/`:
- `overview.md` - Visao geral da arquitetura
- `structure.md` - Estrutura de diretorios
- `file-registry.md` - Registro de arquivos
- `diagnostics.md` - Relatorio de problemas e divida tecnica
- `_meta.json` - Metadados da ultima analise

**Status atual:** Projeto saudavel
- 195 arquivos TypeScript
- 187 testes unitarios passando
- Build compila com sucesso
- Compatibilidade Windows verificada
- Divida tecnica: ZERO (verificado em 2026-02-28)

---

## Planejamento Ativo

**Status:** Concluido - Nenhuma divida tecnica encontrada

### Documentacao de Planejamento
- `docs/planning/prd.md` - PRD principal do projeto
- `docs/planning/ux-design.md` - Especificacao de UX
- `docs/planning/epics.md` - Divisao em epicos
- `docs/planning/debt-analysis.md` - Analise de divida tecnica (2026-02-28)
- `docs/planning/tasks.md` - Tarefas de divida tecnica

### Resultado da Analise
- TODOs reais no codigo: 0
- Patterns de deteccao: 55 (usados pelo qa-auditor)
- Tarefas obrigatorias: 0
- Tarefa opcional: 1 (ativar SpecVersionManager)

---

# Project Notes

Generated by vibe-flow wrap-up

## Project Rules

- Always use exact versions for TypeScript (e.g., "5.3.3" not "^5.3.3") to avoid breaking changes from newer versions
- Tests e2e devem usar ESM imports com fileURLToPath para __dirname
- Fixtures path devem ser resolvidos a partir da raiz do projeto usando path.resolve(__dirname, '../..')
- Interfaces TypeScript devem ter tipos explícitos para todas as propriedades (evitar unknown)

## Session Notes (2026-02-26)
- Tested validateTypeScriptFile() - works correctly
- TypeScript syntax validation via tsc CLI functional
- Updated timeout_utils.sh and package dependencies
- Fixed TypeScript build: pinned to exact version 5.3.3
- Fixed type mismatch in context-summarizer.ts (Summary[] vs Summary)

## Session Notes (2026-02-27)
- Implemented RegressionGuard in src/execution/tdd/regression-guard.ts
  - Validates full test suite after individual test passes
  - Detects side effects and global regressions
  - Types: RegressionType, RegressionSeverity, RegressionRecommendation
  - Methods: validateAfterTaskCompletion(), setBaseline(), compareWithBaseline()
  - Logs to .vibe-flow/regression-log.json
  - Exported via src/execution/tdd/index.ts
- Fixed build: installed @types/node@20.10.0
- Updated failure-analyzer.ts: improved timeout error detection
- Created tests/unit/failure-analyzer.test.ts

## Session Notes (2026-02-27)
- Created FastMarkdownFormatter in src/wrap-up/formatter.ts
- Implemented generateReport(sessionData) method using array buffer pattern
- Uses [].join('\n') instead of += for optimized string assembly
- Separated build methods for each section (header, projectState, decisions, errors, files)
- Session wrap-up executed manually after MCP failure
- Created ContextManager class in src/context/context-manager.ts
- getOptimizedContext() returns lean state and triggers background summarization
- Fixed path.isAbsolute import for Windows compatibility
- 21 unit tests passing - verifies payload reduction

## Session Notes (2026-02-26)
- Implemented cross-rule validation system in src/validation/cross-rule.ts
- Created CrossRuleValidator class with validateConsistency(artifactA, artifactB) method
- Compares primary keys between two specification artifacts (e.g., PRD vs Architecture Document)
- Detects missing keys, extra keys, type mismatches, and value mismatches
- Exports: CrossRuleValidator, validateCrossRule, CrossRuleStatus, ValidationResult types
- Added exports to src/validation/index.ts
- Build compiles successfully (dist/validation/cross-rule.js generated)

## Session Notes (2026-02-26)
- Implemented StateDriftDetector directory hash functionality
- Added calculateDirectoryHash() - calculates SHA-256 hash of all files in .vibe-flow/
- Added saveDirectoryHash() - saves hash to state.json for baseline comparison
- Added checkDirectoryDrift() - compares current hash with saved hash
- Added checkAndWarnDrift() - emits warning to user with "analyze_project" suggestion
- All existing tests pass (14 tests)

## Session Notes (2026-02-27)
- Implemented SecurityScanner class in src/security/secret-scanner.ts
- Created SecurityFinding, SecurityReport, ScanResult interfaces
- Added static methods: scanPayload(), scanForSecrets(), scanForPromptInjection(), hasPromptInjection(), hasSecrets(), getSecretDetails()
- Detects 40+ secret patterns: AWS keys, JWT tokens, OpenAI/Anthropic keys, GitHub tokens, Stripe, Slack, Google, private keys (PEM/RSA/OpenSSH), default passwords
- Detects 11 prompt injection patterns: "ignore previous instructions", role override, jailbreak prompts, system prompt extraction, XML tag injection, base64 encoded instructions, safety bypass
- Fixed Set iteration with Array.from() for ES5 compatibility
- Exported PayloadSecurityScanner (renamed to avoid conflict with scanner.ts) in src/security/index.ts

## Session Notes (2026-02-26)
- Implemented AgentCircuitBreaker pattern in src/error-handler/circuit-breaker.ts
- Created CircuitBreakerState enum (CLOSED, OPEN, HALF_OPEN)
- AgentCircuitBreaker tracks consecutive failures, opens circuit after maxRetries (default: 3)
- CircuitBreakerError custom error with human-in-the-loop suggestions
- Generates contextual suggestions based on error patterns (compilation, test, rate limit, timeout, network)
- Added exports to src/error-handler/index.ts
- Build compiles successfully

## Session Notes (2026-02-26)
- Implemented telemetry system for phase transition tracking
- Added MetricEvent interface to src/types.ts
- Created TelemetryCollector class in src/telemetry/index.ts
- Integrated telemetry timing into StateMachine (transition method)
- Fixed syntax errors in src/help/index.ts and src/error-handler/index.ts
- Build successful - telemetry.json being populated correctly

## Session Notes (2026-02-26)
- Implemented agent driver system with Circuit Breaker pattern
- Created src/drivers/ module with:
  - types.ts: AgentDriver interface with executeTask(task: string)
  - claude-code.ts: ClaudeCodeDriver mock implementation
  - codex.ts: CodexDriver mock implementation
  - router.ts: AgentRouter with Circuit Breaker (CLOSED/OPEN/HALF_OPEN states)
  - Auto-fallback on rate limit errors (429, "Rate Limit", "Too Many Requests")
  - Transparent failover returns DriverResult with success/result/error/driverUsed
- Build successful - all TypeScript compiles correctly

## Session Notes (2026-02-27)
- Created telemetry modules for usage tracking:
  - src/telemetry/logger.ts: Simple logger that appends to .vibe-flow/usage.log
  - src/telemetry/quotaTracker.ts: QuotaTracker class with configurable threshold (default: 50k tokens, 80%)
  - Monitors CLI usage and alerts when exceeding safety threshold
  - Persists state to .vibe-flow/quota-state.json
  - Build verified successfully

## Session Notes (2026-02-27)
- Created context window evaluation tests:
  - tests/fixtures/env_states.json: Mock data with 4 scenarios (8k/128k tokens)
  - tests/e2e/eval.ts: Standalone test runner script
  - tests/e2e/eval.test.ts: Jest test suite (7 tests, all passing)
- Tests verify agent behavior for small (8k) and massive (128k) context windows

## Session Notes (2026-02-27)
- Configured MCP (Model Context Protocol) for vibe-flow:
  - Installed @modelcontextprotocol/sdk@1.27.1
  - Created src/mcp/official-server.ts - Official MCP server using SDK
  - Created src/mcp/client.ts - MCP client for external servers
  - Added .claude/mcp.json - Claude Code MCP configuration
  - Added npm script "mcp" to run MCP server
  - Exposed tools: start_project, advance_step, get_status, analyze_project, wrap_up_session, get_guidance
  - Build successful - all TypeScript compiles correctly
  - Fixed multiple TypeScript build errors in src/quality/, src/security/, src/context/


## Session Notes (2026-02-27)
- Implemented hierarchical DAG summary system for context management:
  - Created src/context/summary-types.ts: LeafSummary, CondensedSummary, MessagePointer, SummaryPointer, DAGState types
  - Created src/context/dag-summary.ts: DAG management with provenance tracking
  - buildActiveContext() combines recent messages with DAG summaries
  - getProvenance() tracks all original message IDs through the DAG hierarchy
  - validateDAG() ensures DAG consistency
  - Build successful - tests pass with active context combining summaries + recent messages

## Session Notes (2026-02-27)
- Created src/decision/state-detector.ts with ProjectState enum (NEW, IN_PROGRESS, REVERSE_ENGINEERING)
- Implemented analyzeProjectMaturity(directoryPath) with heuristic weights:
  - package.json: +10, _bmad: +25, .ralph: +30, .git: +5
- Detection logic: .ralph → IN_PROGRESS, legacy code without BMAD → REVERSE_ENGINEERING, score ≤15 → NEW

## Session Notes (2026-02-27)
- Created secret-scanner.ts module in src/security/
- scanDiffForSecrets(diffText: string): ScanResult function
- Implements 37+ RegEx patterns for detecting: AWS keys, OpenAI/Anthropic tokens, JWTs, private keys (PEM/RSA/OpenSSH), GitHub tokens, Slack, Stripe, Google, Twilio, SendGrid, Mailgun, Discord, Azure, and more
- Returns ScanResult interface with hasSecrets: boolean and findings: string[]
- Zero external npm dependencies - pure Node.js stdlib

## Session Notes (2026-02-27)
- Created src/mcp/permission-guard.ts - MCP permission interceptor
- MCPPermissionGuard class with validateExecution(toolName, parameters) method
- Static POLICIES object with allow/deny/ask rules:
  - Allow: read, glob, grep, web_fetch, web_search, get_status, get_guidance, analyze_project, lcm_* operations
  - Ask: write, edit, bash, exec, shell, unknown tools
  - Deny: delete, remove, reset, rm, rmdir, unlink
- Rigorous error handling with fail-secure (denies on error by default)
- Custom policies can be added at runtime with addCustomPolicy()
- Built successfully - dist/mcp/permission-guard.js and .d.ts generated

## Session Notes (2026-02-26)
- Created WAL recovery module in src/error-handler/wal-recovery.ts
  - WALManager class with appendLog(state) and recoverLastValidState()
  - Uses fs/promises for async file I/O in .vibe-flow/wal/ directory
  - Handles JSON corruption by skipping invalid logs
  - Includes checksum validation for state integrity
  - Added 11 unit tests in tests/unit/wal-recovery.test.ts

## Session Notes (2026-02-27)
- **Project:** vibe-flow
- type mismatch: Type mismatch - Ensure interfaces have explicit types for all properties, avoid unknown (7x)
- type mismatch: Missing file/path - Resolve fixture paths from project root using path.resolve(__dirname, "../..") (7x)
- recurrence: Multiple failed operations - 3 operations failed. Consider reviewing error handling. (7x)

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-27)
- Implemented WorkspaceLockManager in src/state-machine/file-lock.ts
  - LockError class for file lock errors with filepath, currentHolder, requestedBy
  - WorkspaceLockManager with in-memory Map for concurrent file access control
  - acquireLock(filepath, agentId) - acquires lock, throws LockError if already locked
  - releaseLock(filepath, agentId) - releases lock, throws if not locked or wrong agent
  - isLocked(filepath) - checks if file is locked
  - getLockHolder(), getLockedFiles(), getLocksByAgent(), releaseAllLocksByAgent()
  - Exported in src/state-machine/index.ts
  - Fixed TypeScript iteration issues with Array.from() for Map.entries()

## Session Notes (2026-02-27)
- Implemented Worker Thread system for CPU-intensive context compression in src/context/
  - Created worker.ts: Native worker_threads module for offloading parseamento, sanitização, contagem de tokens
  - Created worker-types.ts: WorkerData, WorkerResult, CompressionMetadata interfaces
  - Created worker-wrapper.ts: compressContextAsync() wrapper function
  - Added exports to src/context/index.ts
  - Testado com 100 mensagens: 5200 → 4900 tokens (6% redução)
  - Processamento em thread separada para não bloquear a thread principal

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed
## Session Notes (2026-02-27)
- Created TDDLoopController in src/execution/tdd/loop-controller.ts
- Implements Red-Green-Refactor as state machine (TDDPhase enum)
- runTask(taskDescription) orchestrates sequential async phases
- RED: generates test, rejects if passes immediately (validates TDD contract)
- GREEN: implements code until test passes
- REFACTOR: optional code improvement maintaining test pass
- Uses dependency injection: TestGenerator, ImplementationGenerator, TestRunner
- Configurable iteration limits per phase (max 5 per phase, 15 total)

## Session Notes (2026-02-27)
- Created MemoryRouter class in src/wrap-up/self-improve/memory-router.ts
- Implements routeInsights(insights: string[]): RoutedMemory method
- Routes insights to correct memory level:
  - Global convention -> CLAUDE.md
  - File type specific -> .claude/rules/
  - Ephemeral/WIP -> CLAUDE.local.md
  - Isolated pattern -> Auto memory (JSON in ~/.vibe-flow/auto-memory.json)
- Exports: InsightCategory, MemoryRoute, RoutedMemory, AutoMemoryEntry, AutoMemoryStore, MemoryRouter


## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed
## Session Notes (2026-02-27)
- Created ImplementationDriftDetector in src/validation/drift-detector.ts
- detectDrift(planContent: string, implementationDiff: string): DriftReport
- Detects drift types: FORGOTTEN, PARTIAL, FEATURE_CREEP
- Extracts features from plan markdown and code blocks
- Extracts implemented features from diff file names and declarations
- Uses Levenshtein similarity for fuzzy matching
- Detects partial: TODO/FIXME markers, empty function bodies, throw Error stubs
- Exports: ImplementationDriftDetector, detectDrift, DriftType, DriftSeverity, DriftReport
- Added exports to src/validation/index.ts
- Test file at tests/unit/drift-detector.test.ts

## Session Notes (2026-02-27)
- Added Windows compatibility fix to TelemetryCollector (src/telemetry/index.ts)
  - Added directory existence check before writing telemetry file
  - Added fallback copy/unlink for cross-device moves (EXDEV error)
  - Handles ENOENT errors gracefully
- Created mock-factory.ts for TDD test doubles

## Session Notes (2026-02-27)
- Created TDD prompts module in src/execution/tdd/prompts.ts
  - buildTestGenerationPrompt(task): Generates RED phase prompt for test-only generation
  - buildImplementationPrompt(task, testCode, testErrors?): Generates GREEN phase prompt
  - TDDTask interface with featureName, description, expectedBehavior, constraints, existingCode
  - Prompts enforce test-first mindset, preventing LLM from writing test + implementation together
  - Addresses literature finding that models tend to break TDD by writing both simultaneously

## Session Notes (2026-02-27)
- Created TDD FailureAnalyzer in src/execution/tdd/failure-analyzer.ts
  - parseTestFailure(rawError) extracts test name, expected/received, file/line
  - Supports Jest (● test name) and Vitest (FAIL > test) patterns
  - FailureContext interface with surgical summary for LLM
  - isRetryableFailure() filters non-retryable errors (Syntax/Reference/TypeError)
  - serializeFailureContext() returns minimal string for context
- Created tests/unit/failure-analyzer.test.ts (14 tests passing)

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-26)
- Wrap-up session executed

## Session Notes (2026-02-27)
- Wrap-up session executed

## Session Notes (2026-02-28)
- Executed /flow pipeline for AI Code Review feature
- Completed phases: analyze (5 units), plan (3 units), dev (3 tasks), qa (2 units)
- Pipeline marked as complete: flow-20260227-auth
- Build validation passed (tsc compiles successfully)
- QA Requirements validation: adversarial_review implemented

## Session Notes (2026-02-28) - Context Optimization
- Executed /flow pipeline: flow-20260228-context-opt
- Analyze phase: 5 domain analyses completed (context-engine, context-core, compression-pruning, workers-threads, state-telemetry)
- Plan phase: 4 PRDs created (token-unification, worker-pool, cleaning-unification, cache-optimization)
- Dev phase: 3 modules implemented:
  - src/utils/token-estimation.ts - Centralized token estimation with LRU cache
  - src/context/worker-pool.ts - Worker thread pool for reuse
  - src/context/cleaning-strategy.ts - Unified cleaning interface
- Build compiles successfully
- Committed and pushed to task/002-worker-pool branch